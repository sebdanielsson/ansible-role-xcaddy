---
# Generic installation using Go for all distros
# Downloads Go directly from go.dev for the latest version

- name: Set Go architecture
  ansible.builtin.set_fact:
    go_arch: "{{ 'arm64' if ansible_facts.architecture == 'aarch64' else 'amd64' }}"

- name: Get latest Go version from go.dev API
  ansible.builtin.uri:
    url: https://go.dev/dl/?mode=json
    return_content: true
  register: go_versions_response
  when: xcaddy_go_version == 'latest'

- name: Parse latest stable Go version
  ansible.builtin.set_fact:
    go_version: "{{ (go_versions_response.json | selectattr('stable', 'equalto', true) | first).version | regex_replace('^go', '') }}"
  when: xcaddy_go_version == 'latest'

- name: Use pinned Go version
  ansible.builtin.set_fact:
    go_version: '{{ xcaddy_go_version }}'
  when: xcaddy_go_version != 'latest'

- name: Display Go version to install
  ansible.builtin.debug:
    msg: 'Installing Go version: {{ go_version }}'

- name: Check if Go is already installed
  ansible.builtin.stat:
    path: /usr/local/go/bin/go
  register: go_binary

- name: Get installed Go version
  ansible.builtin.command:
    cmd: /usr/local/go/bin/go version
  register: go_installed_version
  changed_when: false
  failed_when: false
  when: go_binary.stat.exists

- name: Determine if Go installation is needed
  ansible.builtin.set_fact:
    go_install_needed: >-
      {{
        not go_binary.stat.exists
        or ('go' ~ go_version) not in (go_installed_version.stdout | default(''))
      }}

- name: Download Go tarball
  ansible.builtin.get_url:
    url: 'https://go.dev/dl/go{{ go_version }}.linux-{{ go_arch }}.tar.gz'
    dest: '/tmp/go{{ go_version }}.linux-{{ go_arch }}.tar.gz'
    mode: '0644'
  become: true
  when: go_install_needed

- name: Remove existing Go installation
  ansible.builtin.file:
    path: /usr/local/go
    state: absent
  become: true
  when: go_install_needed

- name: Extract Go tarball
  ansible.builtin.unarchive:
    src: '/tmp/go{{ go_version }}.linux-{{ go_arch }}.tar.gz'
    dest: /usr/local
    remote_src: true
  become: true
  when: go_install_needed

- name: Clean up Go tarball
  ansible.builtin.file:
    path: '/tmp/go{{ go_version }}.linux-{{ go_arch }}.tar.gz'
    state: absent
  become: true
  when: go_install_needed

- name: Ensure Go is in system PATH
  ansible.builtin.lineinfile:
    path: /etc/profile
    line: 'export PATH=$PATH:/usr/local/go/bin'
    state: present
    create: false
  become: true

- name: Install xcaddy via go install
  ansible.builtin.command:
    cmd: /usr/local/go/bin/go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest
    creates: /root/go/bin/xcaddy
  environment:
    GOPATH: /root/go
    GOPROXY: '{{ xcaddy_goproxy }}'
  become: true

- name: Set xcaddy binary path
  ansible.builtin.set_fact:
    xcaddy_bin: /root/go/bin/xcaddy
