---
- name: Check if Caddy is already installed
  ansible.builtin.stat:
    path: '{{ xcaddy_bin_path }}'
  register: caddy_binary

- name: Get current Caddy version
  ansible.builtin.command:
    cmd: '{{ xcaddy_bin_path }} version'
  register: caddy_current_version
  changed_when: false
  failed_when: false
  when: caddy_binary.stat.exists

- name: Get current Caddy modules (non-standard only)
  ansible.builtin.command:
    cmd: '{{ xcaddy_bin_path }} list-modules --packages --skip-standard --versions'
  register: caddy_current_modules
  changed_when: false
  failed_when: false
  when: caddy_binary.stat.exists

- name: Filter module lines from output
  ansible.builtin.set_fact:
    caddy_module_lines: >-
      {{
        caddy_current_modules.stdout_lines
        | default([])
        | map('trim')
        | select()
        | reject('search', ':')
        | list
      }}
  when: caddy_binary.stat.exists and caddy_current_modules.rc == 0

- name: Parse installed modules as package@version
  ansible.builtin.set_fact:
    caddy_installed_modules: >-
      {%- set result = [] -%}
      {%- for line in caddy_module_lines -%}
        {%- set parts = line.split() -%}
        {%- if parts | length >= 3 -%}
          {%- set _ = result.append(parts[2] ~ '@' ~ parts[1]) -%}
        {%- endif -%}
      {%- endfor -%}
      {{ result }}
  when: caddy_binary.stat.exists and caddy_current_modules.rc == 0

- name: Set empty modules list if Caddy not installed
  ansible.builtin.set_fact:
    caddy_installed_modules: []
  when: not caddy_binary.stat.exists

- name: Build normalized desired modules list for comparison
  ansible.builtin.set_fact:
    xcaddy_desired_normalized: >-
      {{
        xcaddy_modules
        | map('regex_replace', '@.*$', '')
        | sort
        | list
      }}
    xcaddy_installed_normalized: >-
      {{
        caddy_installed_modules
        | map('regex_replace', '@.*$', '')
        | sort
        | list
      }}
    xcaddy_versioned_modules: >-
      {{
        xcaddy_modules
        | select('search', '@')
        | list
      }}
    xcaddy_unversioned_modules: >-
      {{
        xcaddy_modules
        | reject('search', '@')
        | list
      }}

- name: Check if versioned modules match installed versions
  ansible.builtin.set_fact:
    xcaddy_versions_match: >-
      {{
        xcaddy_versioned_modules | reject('in', caddy_installed_modules) | list | length == 0
      }}

- name: Determine if rebuild is needed
  ansible.builtin.set_fact:
    xcaddy_rebuild_needed: >-
      {{
        not caddy_binary.stat.exists
        or xcaddy_state == 'latest'
        or (xcaddy_caddy_version != 'latest' and xcaddy_caddy_version not in (caddy_current_version.stdout | default('')))
        or xcaddy_desired_normalized != xcaddy_installed_normalized
        or not xcaddy_versions_match
        or (xcaddy_unversioned_modules | length > 0)
      }}

- name: Display rebuild status
  ansible.builtin.debug:
    msg: |
      Caddy rebuild needed: {{ xcaddy_rebuild_needed }}
      - Binary exists: {{ caddy_binary.stat.exists }}
      - xcaddy_state: {{ xcaddy_state }}
      - xcaddy_caddy_version: {{ xcaddy_caddy_version }}
      - Current version: {{ caddy_current_version.stdout | default('N/A') }}
      - Desired modules: {{ xcaddy_modules | sort }}
      - Installed modules: {{ caddy_installed_modules | sort }}
      - Packages match: {{ xcaddy_desired_normalized == xcaddy_installed_normalized }}
      - Versions match: {{ xcaddy_versions_match }}
      - Has unversioned modules: {{ xcaddy_unversioned_modules | length > 0 }}

- name: Build Caddy version string
  ansible.builtin.set_fact:
    xcaddy_version_arg: "{{ '' if xcaddy_caddy_version == 'latest' else xcaddy_caddy_version }}"
  when: xcaddy_rebuild_needed

- name: Build module arguments
  ansible.builtin.set_fact:
    xcaddy_module_args: '{% for mod in xcaddy_modules %}--with {{ mod }} {% endfor %}'
  when: xcaddy_rebuild_needed

- name: Create build directory
  ansible.builtin.file:
    path: '{{ xcaddy_build_dir }}'
    state: directory
    mode: '0755'
  become: true
  when: xcaddy_rebuild_needed

- name: Build Caddy with xcaddy
  ansible.builtin.shell:
    cmd: >
      {{ xcaddy_bin }} build {{ xcaddy_version_arg }}
      {{ xcaddy_module_args }}
      --output {{ xcaddy_build_dir }}/caddy
    chdir: '{{ xcaddy_build_dir }}'
  environment:
    GOPROXY: '{{ xcaddy_goproxy }}'
    PATH: '/usr/local/go/bin:{{ ansible_env.PATH }}'
  become: true
  register: xcaddy_build_result
  changed_when: true
  when: xcaddy_rebuild_needed

- name: Verify Caddy binary was built
  ansible.builtin.stat:
    path: '{{ xcaddy_build_dir }}/caddy'
  register: caddy_built_binary
  when: xcaddy_rebuild_needed

- name: Fail if Caddy binary was not built
  ansible.builtin.fail:
    msg: |
      Caddy build failed! xcaddy did not produce a binary.
      Build output: {{ xcaddy_build_result.stderr | default('No stderr') }}
  when: xcaddy_rebuild_needed and not caddy_built_binary.stat.exists

- name: Install Caddy binary
  ansible.builtin.copy:
    src: '{{ xcaddy_build_dir }}/caddy'
    dest: '{{ xcaddy_bin_path }}'
    owner: root
    group: root
    mode: '0755'
    remote_src: true
  become: true
  notify: Restart Caddy
  when: xcaddy_rebuild_needed

- name: Clean up build directory
  ansible.builtin.file:
    path: '{{ xcaddy_build_dir }}'
    state: absent
  become: true
  when: xcaddy_rebuild_needed
